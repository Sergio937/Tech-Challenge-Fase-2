services:
  # -----------------------------------------------------------
  # Localstack (SQS + DynamoDB)
  # -----------------------------------------------------------
  localstack:
    image: localstack/localstack:3.0
    container_name: localstack
    environment:
      SERVICES: sqs,dynamodb
      AWS_DEFAULT_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET}
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/var/lib/localstack
      - ./localstack-init.sh:/etc/localstack/init/ready.d/localstack-init.sh

  # -----------------------------------------------------------
  # Redis
  # -----------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "${REDIS_PORT}:6379"

  # -----------------------------------------------------------
  # Auth Service + PostgreSQL
  # -----------------------------------------------------------
  auth-db:
    image: postgres:15
    container_name: auth-db
    environment:
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASS}
      POSTGRES_DB: ${AUTH_DB_NAME}
    volumes:
      - auth_data:/var/lib/postgresql/data
      - ./auth-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${AUTH_DB_PORT}:5432"

  auth-service:
    build: ./auth-service
    image: marcelosilva404/auth-service:1.0
    container_name: auth-service
    restart: always
    depends_on:
      - auth-db
    environment:
      PORT: ${AUTH_PORT}
      MASTER_KEY: ${MASTER_KEY}
      DATABASE_URL: postgres://${AUTH_DB_USER}:${AUTH_DB_PASS}@auth-db:5432/${AUTH_DB_NAME}?sslmode=disable
    ports:
      - "${AUTH_PORT}:${AUTH_PORT}"

  # -----------------------------------------------------------
  # Flag Service + PostgreSQL
  # -----------------------------------------------------------
  flag-postgres:
    image: postgres:15
    container_name: flag-postgres
    environment:
      POSTGRES_USER: ${FLAG_DB_USER}
      POSTGRES_PASSWORD: ${FLAG_DB_PASS}
      POSTGRES_DB: ${FLAG_DB_NAME}
    volumes:
      - flag_data:/var/lib/postgresql/data
      - ./flag-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${FLAG_DB_PORT}:5432"

  flag-service:
    build: ./flag-service
    image: marcelosilva404/flag-service:1.0
    container_name: flag-service
    depends_on:
      - flag-postgres
      - auth-service
    environment:
      DATABASE_URL: postgres://${FLAG_DB_USER}:${FLAG_DB_PASS}@flag-postgres:5432/${FLAG_DB_NAME}
      AUTH_SERVICE_URL: http://auth-service:${AUTH_PORT}
      PORT: ${FLAG_PORT}
    ports:
      - "${FLAG_PORT}:${FLAG_PORT}"

  # -----------------------------------------------------------
  # Targeting Service + PostgreSQL
  # -----------------------------------------------------------
  targeting-db:
    image: postgres:15
    container_name: targeting-db
    environment:
      POSTGRES_USER: ${TARGET_DB_USER}
      POSTGRES_PASSWORD: ${TARGET_DB_PASS}
      POSTGRES_DB: ${TARGET_DB_NAME}
    volumes:
      - targeting_data:/var/lib/postgresql/data
      - ./targeting-service/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${TARGET_DB_PORT}:5432"

  targeting-service:
    build: ./targeting-service
    image: marcelosilva404/targeting-service:1.0
    container_name: targeting-service
    depends_on:
      - targeting-db
      - auth-service
    environment:
      PORT: ${TARGET_PORT}
      DATABASE_URL: postgres://${TARGET_DB_USER}:${TARGET_DB_PASS}@targeting-db:5432/${TARGET_DB_NAME}
      AUTH_SERVICE_URL: http://auth-service:${AUTH_PORT}
    ports:
      - "${TARGET_PORT}:${TARGET_PORT}"

  # -----------------------------------------------------------
  # Evaluation Service
  # -----------------------------------------------------------
  evaluation-service:
    build: ./evaluation-service
    image: marcelosilva404/evaluation-service:1.0
    container_name: evaluation-service
    depends_on:
      - redis
      - localstack
      - flag-service
      - targeting-service
    environment:
      PORT: ${EVAL_PORT}
      REDIS_URL: redis://redis:${REDIS_PORT}
      FLAG_SERVICE_URL: http://flag-service:${FLAG_PORT}
      TARGETING_SERVICE_URL: http://targeting-service:${TARGET_PORT}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET}
      AWS_REGION: ${AWS_REGION}
      SERVICE_API_KEY: ${SERVICE_API_KEY}
      AWS_SQS_URL: http://localstack:4566/000000000000/evaluation-events
      AWS_SQS_ENDPOINT: http://localstack:4566
    ports:
      - "${EVAL_PORT}:${EVAL_PORT}"

  # -----------------------------------------------------------
  # Analytics Service
  # -----------------------------------------------------------
  analytics-service:
    build: ./analytics-service
    image: marcelosilva404/analytics-service:1.0
    container_name: analytics-service
    depends_on:
      - localstack
    environment:
      PORT: ${ANALYTICS_PORT}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET}
      AWS_SQS_URL: http://localstack:4566/000000000000/evaluation-events
      AWS_SQS_ENDPOINT: http://localstack:4566
      AWS_DYNAMODB_TABLE: ${DYNAMO_TABLE}
      AWS_DYNAMODB_ENDPOINT: http://localstack:4566
    ports:
      - "${ANALYTICS_PORT}:${ANALYTICS_PORT}"

volumes:
  localstack_data:
  auth_data:
  flag_data:
  targeting_data: